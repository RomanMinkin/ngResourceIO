/*!
 * Module for Angular.js framework, a factory which creates a resource object that lets interact with server-side data sources by using  WebSockets as  transport layer.
 *
 * @version v0.0.1
 * @link https://github.com/RomanMinkin/ngResourceIO
 * @author Roman Minkin <minkinroman@gmail.com>
 * @license MIT License, https://raw.github.com/RomanMinkin/ngResourceIO/master/LICENSE
 */
!function(a){"use strict";function b(b,c){c=c||{},a.forEach(c,function(a,b){delete c[b]});for(var d in b)!b.hasOwnProperty(d)||"$"===d.charAt(0)&&"$"===d.charAt(1)||(c[d]=b[d]);return c}var c=a.$$minErr("ngResourceIO");a.module("ngResourceIO",[]).provider("$socket",function(){var b={},c={socketstream:{SOCKET_TYPE:"socketstream",SOCKET_INSTANCE:"ss",SOCKET_EVENT_METHOD:"event",SOCKET_RPC_METHOD:"rpc",SOCKET_SEND_METHOD:"send",SOCKET_MODEL_METHOD_DELIMITER:".",SOCKET_MODEL_EVENT_PREFFIX:"pubsub",SOCKET_MODEL_EVENT_DELIMITER:":",SOCKET_MESSAGE_PARSE:!1},"socket.io":{SOCKET_TYPE:"socket.io",SOCKET_INSTANCE:"socket",SOCKET_EVENT_METHOD:null,SOCKET_RPC_METHOD:null,SOCKET_SEND_METHOD:"send",SOCKET_MODEL_EVENT_PREFFIX:"pubsub",SOCKET_MODEL_METHOD_DELIMITER:":",SOCKET_MESSAGE_PARSE:!1}},d="socketstream";this.setConfig=function(c,d){return c&&""!==c&&"string"==typeof c&&"object"==typeof d?(b[c]?a.extend({},d,b[c]):b[c]=d,!0):!1},this.getConfig=function(a){return a?b[a]:b},this.getDefaults=function(a){return a?c[a]:c},this.use=function(a,e){return c[a]?(e&&(d=a),b[a]=c[a],!0):e&&b[a]&&d!==a?(d=a,!0):!1},this.getDefaultConfigName=function(){return d},this.$get=["$rootScope","$q",function(c,e){function f(a){return a?b[a]:b[d]}function g(a,b){function d(){var a=Array.prototype.slice.apply(arguments)[0],b=Array.prototype.slice.apply(arguments)[1];c.$apply(function(){a?h.reject(a):h.resolve(b)})}var f=window[b.SOCKET_INSTANCE][b.SOCKET_RPC_METHOD],g=Array.prototype.slice.apply(arguments),h=e.defer();return"socket.io"===b.SOCKET_TYPE?(f.apply(window[b.SOCKET_INSTANCE],[a].concat(g.slice(2,g.length))),window[b.SOCKET_INSTANCE].on(a,d),h.promise):"socketstream"===b.SOCKET_TYPE?(f.apply(window[b.SOCKET_INSTANCE],[a].concat(g.slice(2,g.length)).concat(d)),h.promise):void 0}var h,i,j={};for(i in b)b.hasOwnProperty(i)&&(j[i]={rpc:function(a){var c=Array.prototype.slice.apply(arguments);return g.apply(g,[a,b[i]].concat(c.slice(1,c.length)))}},i===d&&(h=j[i].rpc));return a.extend(j,{getConfig:f,rpc:h})}]}).factory("$resourceIO",["$rootScope","$parse","$q","$socket",function(d,e,f,g){function h(h,q,r,s){function t(a){return a.resource}function u(a,b){d.$apply(function(){d.$broadcast(x,a,b)})}function v(){return 0===i.listeners(x).length?(i.on(x,u),!0):!1}function w(a){var c=this;b(a||{},this),c.$_listeners={},c.reatachEventsListener=function(){return d.$on(x,function(a,b,d){var e,f;s[b]&&(e=s[b],f=e.idField||"id",c[f]===d[f]&&(e.fn&&"function"==typeof e.fn?e.fn(c,d):"remove"===b&&n(c.$_listeners,function(a){a()})))})},c.$_listeners[x]=c.reatachEventsListener()}var x=[j.SOCKET_MODEL_EVENT_PREFFIX,h].join(j.SOCKET_MODEL_EVENT_DELIMITER);return r=o({},k,r),s=o({},l,s),q=o({},q),w.on=function(a,b){return a||b||this!==w?void(s[a]&&d.$on(x,function(c,d,e){a===d&&b(s[a].isNew?new w(e):e)})):v()},w.off=function(){d.$$listeners&&d.$$listeners[x]&&delete d.$$listeners[x],i.listeners(x).length>0&&i.off(x,u)},w.prototype.on=function(){return this.$_listeners[x]?!1:(this.$_listeners[x]=this.reatachEventsListener(),!0)},w.prototype.off=function(){n(this.$_listeners,function(a){a()}),this.$_listeners={}},n(r,function(d,i){var k,l,o,q,r,s,u;w[i]=function(v,x,y,z){var A,B,C,D={};switch(arguments.length){case 4:C=z,B=y;case 3:case 2:if(!p(x)){D=v,A=x,B=y;break}if(p(v)){B=v,C=x;break}B=x,C=y;case 1:p(v)?B=v:D=v;break;case 0:break;default:throw c("badargs","[ngResourceIO->$resourceIO] Expected up to 4 arguments [params, data, success, error], got {0} arguments",arguments.length)}return k=A instanceof w,q=k?A:d.isArray?[]:new w(A),l=d.interceptor&&d.interceptor.response||t,o=d.interceptor&&d.interceptor.responseError||void 0,r=g.rpc(h+j.SOCKET_MODEL_METHOD_DELIMITER+i,D).then(function(f){var g=f,h=q.$promise;if(g){if(a.isArray(g)!==Boolean(d.isArray))throw c("badcfg","[ngResourceIO->$resourceIO] Error in resource configuration. Expected response to contain an {0} but got an {1}",d.isArray?"array":"object",a.isArray(g)?"array":"object");if(d.isArray)q.length=0,n(g,function(a){q.push(new w(a))});else if(d.isPath&&!d.isArray){if(s=e(D),u=s.assign,!s(g))throw c("badargs","[ngResourceIO->$resourceIO] Mismatch in 'isPath' method call! Method '{0}({1})' for object modifying been called. Server sent wrong response: '{2}'",i,D,JSON.stringify(f));u(q,s(g))}else b(g,q),q.$promise=h}return q.$resolved=!0,f=q},function(a){return q.$resolved=!0,(C||m)(a),f.reject(a)}),r=r.then(function(a){var b=l(a);return(B||m)(b,a),b},o),k?r:(q.$promise=r,q.$resolved=!1,q)},w.prototype["$"+i]=function(a,b,c){p(a)&&(c=b,b=a,a={});var d=w[i](a,this,b,c);return d.$promise||d}}),q.noListeners||v(),w}var i,j=g.getConfig(),k={findById:{method:"find"},find:{method:"find",isArray:!0},set:{method:"set",isPath:!0},get:{method:"get",isPath:!0},push:{method:"push",isPath:!0},addToSet:{method:"addToSet",isPath:!0},inc:{method:"inc",isPath:!0},save:{method:"save"},remove:{method:"remove"}},l={"new":{isNew:!0},update:{idField:"id",fn:function(a,b){q(b,a)}},set:{idField:"id",isPath:!0,fn:function(a,b){o(a,b)}},remove:{idField:"id"}},m=a.noop,n=a.forEach,o=a.extend,p=a.isFunction,q=a.copy;if(!j)throw c("badconf","[ngResourceIO->$socketProvider] Default config for socket instance has not been found! Please use `$socketProvider.use('config_name', true);` inside `app.config(){...}` defenition!");return i=j.SOCKET_EVENT_METHOD?window[j.SOCKET_INSTANCE][j.SOCKET_EVENT_METHOD]:window[j.SOCKET_EVENT_METHOD],h}])}(angular);